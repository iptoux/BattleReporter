{% extends 'base.html' %}

{% set pageTitle = 'Create New BR' %}
{% set battleInReview = true %}

{% block head %}
<style>
    .autocomplete-suggestions { border:1px solid #999;background:#fff;overflow:auto;color:#333; }
    .autocomplete-suggestion { padding:2px 5px;white-space:nowrap;overflow:hidden; }
    .autocomplete-selected { background:#f0f0f0; }
    .autocomplete-suggestions strong { font-weight:normal;color: #3399FF; }
    .autocomplete-group { padding:2px 5px; }
    .autocomplete-group strong { display:block;border-bottom:1px solid #000; }
</style>
{% endblock %}

{% block content %}
    <h1>Create New BattleReport</h1>
    <div class="panel panel-{% if battleTimespan is defined and battleSolarSystem is defined %}default{% else %}primary{% endif %}">
        <div class="panel-heading">
            <h3 class="panel-title">{% if battleReport is not defined %}Search for Battle{% else %}Detected Battle{% endif %}</h3>
        </div>
        <div class="panel-body row">
            
            {% if battleTimespanError == true %}
            <div class="alert alert-danger">
                <strong>Oh snap!</strong> Please correct the timespan according to the shown pattern and try submitting again.
            </div>
            {% endif %}
            
            {% if battleSolarSystemError == true %}
            <div class="alert alert-danger">
                <strong>Darn!</strong> The system name &quot;{{ inputBattleSolarSystemName }}&quot; causes headache! Please correct it and try submitting again.
            </div>
            {% endif %}
            
            {% if battleTimespan is not defined or battleSolarSystem is not defined %}
            <form method="post" action="/create">
                <div class="col-xs-6">
                    <div class="form-group{% if battleTimespanError == true %} has-error{% endif %}">
                        <label for="battleTimespan" class="control-label">Timespan:</label>
                        <input class="form-control" id="battleTimespan" name="battleTimespan" placeholder="YYYY-MM-DD HH:MM - HH:MM" pattern="[0-9]{4}-([0-1][0-2]|0[1-9])-[0-3][0-9] [0-2][0-9]:[0-5][0-9] - [0-2][0-9]:[0-5][0-9]" value="{{ inputBattleTimespan }}">
                    </div>
                </div>
                <div class="col-xs-6">
                    <div class="form-group{% if battleSolarSystemError == true %} has-error{% endif %}">
                        <label for="battleTimespan" class="control-label">Solar System:</label>
                        <div class="input-group">
                            <input class="form-control" id="battleSolarSystemName" name="battleSolarSystemName" value="{{ inputBattleSolarSystemName }}">
                            <span class="input-group-btn">
                                <button class="btn btn-primary" type="submit">Search ...</button>
                            </span>
                        </div>
                    </div>
                </div>
                <input type="hidden" id="battleSolarSystemId" name="battleSolarSystemId" value="">
            </form>
            {% else %}
                <div class="col-xs-6">
                    <label class="control-label">Timespan:</label>
                    <div>{% if battleReport is defined and battleReport.timeSpan != '' %}{{ battleReport.timeSpan }}{% else %}{{ battleTimespan }}{% endif %}</div>
                </div>
                <div class="col-xs-6">
                    <label class="control-label">Solar System:</label>
                    <div>{% if battleReport is defined and battleReport.solarSystemName != '' %}{{ battleReport.solarSystemName }}{% else %}{{ battleSolarSystem.name }}{% endif %}</div>
                </div>
            {% endif %}
        </div>
    </div>
    
    <div class="panel panel-{% if battleTimespan is defined and battleSolarSystem is defined %}primary{% else %}default{% endif %}">
        <div class="panel-heading">
            <h3 class="panel-title">Edit Battle</h3>
        </div>
        
        {% if battleTimespan is defined and battleSolarSystem is defined %}
        <div class="panel-body">
            
            {% if battleReport is not defined %}
            <div class="alert alert-danger">
                <strong>Dammit!</strong> Something bad happened while trying to prepare the battle report.
                {% if battleReportError is defined %}
                <p>{{ battleReportError }}</p>
                {% endif %}
            </div>
            {% else %}
            
            {% if battleReport.killsTotal == 0 %}
            <div class="alert alert-warning">
                <p><strong>No kills found</strong></p>
                <p>involving <kbd>{{ BR_OWNERCORP_NAME }}</kbd> for <kbd>{{ battleTimespan }}</kbd> in <kbd>{{ battleSolarSystem.name }}</kbd>.<br>
                    It's possible that the kills you're looking for have not yet been fetched by <kbd>{{ BR_FETCH_SOURCE_NAME }}</kbd>.<br>
                    Please try again later.</p>
            </div>
            {% else %}
            <form method="post" action="/edit/{{ battleReport.battleReportID }}">
                <div class="form-group">
                    <label for="battleTitle" class="control-label">Title:</label>
                    <input class="form-control" id="battleTitle" name="battleTitle" value="{{ battleReport.title }}">
                </div>
                <input type="hidden" id="battleReportChanges" name="battleReportChanges" value="">
            </form>
        </div>
        <div class="panel-heading">
            <h3 class="panel-title">
                Assign Battle-Parties 
            </h3>
        </div>
        <div class="panel-body">
            <div class="row">
                <div class="col-xs-4">
                    {% set currentTeamName = "Team A" %}
                    {% set currentTeamID = "teamA" %}
                    {% set currentTeam = battleReport.teamA %}
                    {% include 'components/teamList.html' %}
                </div>
                <div class="col-xs-4">
                    {% set currentTeamName = "Team B" %}
                    {% set currentTeamID = "teamB" %}
                    {% set currentTeam = battleReport.teamB %}
                    {% include 'components/teamList.html' %}
                </div>
                <div class="col-xs-4">
                    {% set currentTeamName = "Team C" %}
                    {% set currentTeamID = "teamC" %}
                    {% set currentTeam = battleReport.teamC %}
                    {% include 'components/teamList.html' %}
                </div>
            </div>
        </div>
        <div class="panel-footer">
            <div class="row">
                <div class="col-xs-12 text-right">
                    <a href="/" class="btn btn-default">Dismiss</a>
                    <button class="btn btn-primary" id="save-br">Save BattleReport</button>
                </div>
            </div>
            {% endif %}
            
            {% endif %}
        </div>
        {% endif %}
        
    </div>
{% endblock %}

{% block scripts %}
<style>
    .not-movable-left .move-left,
    .not-movable-right .move-right,
    .not-hideable .hide-on-br,
    .not-showable .show-on-br,
    .not-trashable .trash { display:none; }
    .hidden-on-br { opacity:0.5; }
</style>
<div id="editor-panel" style="display:none">
    <div  class="btn-group btn-group-sm">
        <a href="#" class="move-left btn btn-primary"><span class="glyphicon glyphicon-chevron-left"></span></a>
        <a href="#" class="move-right btn btn-primary"><span class="glyphicon glyphicon-chevron-right"></span></a>
    </div>
    <div  class="btn-group btn-group-sm">
        <a href="#" class="show-on-br btn btn-primary"><span class="glyphicon glyphicon-eye-open"></span></a>
        <a href="#" class="hide-on-br btn btn-primary"><span class="glyphicon glyphicon-eye-close"></span></a>
    </div>
    <div  class="btn-group btn-group-sm">
        <a href="#" class="trash btn btn-primary"><span class="glyphicon glyphicon-trash"></span></a>
    </div>
</div>
<script src="/js/jquery.autocomplete.min.js"></script>
<script>
    {% if battleTimespan is not defined or battleSolarSystem is not defined %}
    $('#battleSolarSystemName').autocomplete({
        serviceUrl: '/autocomplete/solarSystems',
        type: 'POST',
        transformResult: function(response) {
            var s = [];
            if (!!response && !!(response = $.parseJSON(response)))
                s = $.map(response.solarSystems, function(item) {
                    return { value: item.name, data: item.id };
                });
            return {
                suggestions: s
            };
        },
        onSelect: function (suggestion) {
            if (!!suggestion.data)
                $('#battleSolarSystemId').val(suggestion.data);
        }
    });
    {% endif %}
    {% if battleTimespan is defined and battleSolarSystem is defined and battleReport is defined and battleReport.killsTotal > 0 %}
    !function(battlereport, teamNames, combatants, editor){
        if (!battlereport) return;
        teamNames = ['teamA', 'teamB', 'teamC'];
        combatants = [];
        function getCombatant(id) {
            if (!id) return null;
            l = combatants.length;
            while (l--) {
                if ((c = combatants[l]).brCombatantID == id) return c;
            }
            return null;
        }
        function handle(action, el) {
            var combatant = getCombatant(el.attr('data-combatant-id'));
            if (!combatant) return;
            switch (action) {
                case 'move-left':
                    var oldTeam = battlereport[combatant._team].members,
                        oldTeamIdx = teamNames.indexOf(combatant._team),
                        idx = oldTeam.indexOf(combatant),
                        newTeamName = teamNames[(oldTeamIdx == 0 ? teamNames.length : oldTeamIdx) - 1];
                    battlereport[(combatant._team = newTeamName)].members.push(combatant);
                    el.appendTo($('#battlereport-' + newTeamName));
                    break;
                case 'move-right':
                    var oldTeam = battlereport[combatant._team].members,
                        oldTeamIdx = teamNames.indexOf(combatant._team),
                        idx = oldTeam.indexOf(combatant),
                        newTeamName = teamNames[((oldTeamIdx + 1) == teamNames.length ? -1 : oldTeamIdx) + 1];
                    battlereport[(combatant._team = newTeamName)].members.push(combatant);
                    el.appendTo($('#battlereport-' + newTeamName));
                    break;
                case "hide-on-br":
                    if (!combatant.died) {
                        combatant.brHidden = true;
                        el.addClass('hidden-on-br');
                    }
                    break;
                case "show-on-br":
                    combatant.brHidden = false;
                    if (el.hasClass('hidden-on-br'))
                        el.removeClass('hidden-on-br');
                    break;
                case "trash":
                    combatant.brDeleted = true;
                    el.detach();
                    break;
            }
        }
        for (var teamName in battlereport) {
            if (teamNames.indexOf(teamName) == -1)
                continue;
            var team = battlereport[teamName],
                l = team.members.length,
                combatant;
            while (l--) {
                combatants.push(combatant = team.members[l]);
                combatant._team = teamName;
            }
        }
        editor = $('#editor-panel').css({
            position: 'absolute',
            bottom: 0, right: 0,
            width: 'auto', height: 'auto'
        });
        ['move-left', 'move-right', 'show-on-br', 'hide-on-br', 'trash'].forEach(function (n) {
            $('#editor-panel .' + n).click(function (e) {
                e.preventDefault();
                handle(n, $(this).closest('.combatant'));
            });
        });
        $('*[data-combatant-id]').hover(function () {
            var el = $(this),
                cmbt = getCombatant(el.attr('data-combatant-id')),
                cnt = el.find('.combatant-details');
            if (!cmbt) return;
            cnt.css('position', 'relative');
            editor.attr('class', '');
            if (cmbt._team == 'teamA') editor.addClass('not-movable-left');
            if (cmbt._team == 'teamC') editor.addClass('not-movable-right');
            if (cmbt.brCombatantID == 0)
                editor.addClass('not-hideable').addClass('not-showable');
            else
                editor.addClass('not-trashable').addClass(cmbt.brHidden ? 'not-hideable' : 'not-showable');
            if (cmbt.died)
                editor.addClass(cmbt.brHidden ? 'not-showable' : 'not-hideable');
            editor.appendTo(cnt).show();
        }, function () {
            editor.hide();
        });
        $('#save-br').click(function () {
           $('#battleReport').val(battlereport);
        });
    }({{ battleReport.toJSON()|raw }});
    {% endif %}
</script>
{% endblock %}